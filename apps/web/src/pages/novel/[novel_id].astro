---
export const prerender = false;

import GridNovelResults from "@/components/display/GridNovelResults.astro";
import { Button } from "@/components/starwind/button";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";

const { novel_id } = Astro.params;

const novel = {
  novel_id: "0123",
  title: "title1 title1 title1 title1 title1 title1title1title1",
  description:
    "description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description description",
  original_language: "jp",
  image:
    "https://mangadex.org/covers/b0b721ff-c388-4486-aa0f-c2b0bb321512/f6fb40bf-f4e5-4163-a2c7-f103200873c3.jpg.512.jpg",
  status: "Ongoing",
  genres: [
    "genre1",
    "genre1",
    "genre1",
    "genre1",
    "genre1",
    "genre1",
    "genre1",
  ],
  rating: "9.2",
  num_ratings: "520",
  num_reviews: "102",
  readers: "10k",
};
---

<div class="relative">
  <div
    class="flex flex-col justify-between absolute h-64 w-full
  bg-size-[110%]
  bg-position-[center_50%]"
    style={`background-image:url("${novel.image}")`}
  >
  </div>

  <div class="absolute top-0 left-0 w-full bg-black/40 backdrop-blur-sm h-64">
  </div>

  <BaseLayout>
    <div class="flex gap-4">
      <img
        src={novel.image}
        class="aspect-[5/7] object-cover rounded-md z-20 w-42 h-60 max-[524px]:w-21 max-[524px]:h-30"
      />
      <div class="flex flex-col w-full">
        <div class="flex flex-col justify-between h-42 w-full">
          <span
            id="novel-title"
            class="font-bold h-32 block break-words leading-[1.1] drop-shadow-[1px_2px_4px_rgba(0,0,0,0.3)] text-white invisible"
          >
            <Icon name="flag:jp-4x3" class="inline shadow mr-1" />
            {novel.title}
          </span>
          <div class="flex items-end z-25">
            <span
              class="text-xl drop-shadow-[1px_2px_4px_rgba(0,0,0,0.3)] text-white max-[524px]:absolute max-[524px]:left-4"
            >
              Author
              <div
                class="flex gap-2 text-sm max-[524px]:text-xs max-[524px]:gap-1"
              >
                <span class="flex items-center gap-0.5">
                  <Icon name="tabler:star" class="w-3 h-3" />
                  {novel.rating}/{novel.num_ratings}
                </span>
                <span class="flex items-center gap-0.5">
                  <Icon name="tabler:message" class="w-3 h-3" />
                  {novel.num_reviews}
                </span>
                <span class="flex items-center gap-0.5">
                  <Icon name="tabler:user-plus" class="w-3 h-3" />
                  {novel.readers}
                </span>
              </div>
            </span>
            <div class="absolute right-4">
              <Button size="sm"> <Icon name="tabler:edit" /> </Button>
              <Button size="sm"><Icon name="tabler:history" /></Button>
              <Button size="sm">
                <Icon name="tabler:exclamation-circle" />
              </Button>
            </div>
          </div>
        </div>
        <div
          class="flex items-center gap-2 pt-6 max-[524px]:relative max-[524px]:right-25"
        >
          <Button size="lg" class="[&_svg]:size-5">
            <Icon name="tabler:book" />
            <span class="max-[790px]:hidden">Start Reading</span>
          </Button>
          <Button size="lg" class="[&_svg]:size-5 max-[924px]:p-3">
            <Icon name="tabler:bookmark" />
            <span class="max-[924px]:hidden">Add to List</span>
          </Button>
          <Button size="lg" class="px-3"><Icon name="tabler:share" /></Button>
        </div>
      </div>
    </div>

    <div class="flex gap-4 pt-2">
      <aside class="w-42 flex-shrink-0 hidden lg:block">
        <span class="text-lg font-bold mb-2">MORE DETAILS</span>
        <div class="flex flex-col gap-2 text-sm">
          <div class="space-y-0.5">
            <p>
              <b class="font-semibold">Status:</b>
              <span class="text-green-400">{novel.status}</span>
            </p>
            <p><b class="font-semibold">Available:</b> 197 chapters</p>
            <p><b class="font-semibold">Lasted updated:</b> 10/25/2025</p>
          </div>
          <div class="space-y-0.5">
            <p><b class="font-semibold">Author(s):</b> Author</p>
            <p><b class="font-semibold">Publisher(s):</b> Publisher</p>
            <p><b class="font-semibold">Publishing Date:</b> 10/25/2025</p>
          </div>
          <div class="space-y-0.5">
            <p><b class="font-semibold">Original Language:</b> Japanese</p>
            <p>
              <b class="font-semibold">Available Language(s):</b> English, Japanese
            </p>
          </div>
        </div>
      </aside>
      <div
        id="details-container"
        class="flex flex-1 gap-4 h-40 lg:h-auto relative mb-2 overflow-hidden"
      >
        <div class="flex-2">
          <div class="mb-2">
            <span class="text-lg font-bold mb-4">GENRES</span>
            <div class="flex flex-wrap">
              {
                novel.genres.map((genre) => (
                  <a
                    href={`/genre/${genre}`}
                    class="bg-foreground/10 hover:bg-foreground/12 px-2 py-1 mr-1 mb-1 font-semibold rounded text-sm"
                  >
                    {genre}
                  </a>
                ))
              }
            </div>
          </div>
          <div class="mb-2">
            <span class="text-lg font-bold mb-2">DESCRIPTION</span>
            <p class="text-foreground/90 leading-relaxed text-sm">
              {novel.description}
            </p>
          </div>

          <div class="mb-2 w-full lg:w-42 flex-shrink-0 block lg:hidden">
            <span class="text-lg font-bold block">MORE DETAILS</span>
            <div class="flex flex-wrap space-x-4 space-y-2 text-sm">
              <div class="space-y-0.5">
                <p>
                  <b class="font-semibold">Status:</b>
                  <span class="text-green-400">{novel.status}</span>
                </p>
                <p><b class="font-semibold">Available:</b> 197 chapters</p>
                <p><b class="font-semibold">Lasted updated:</b> 10/25/2025</p>
              </div>
              <div class="space-y-0.5">
                <p><b class="font-semibold">Author(s):</b> Author</p>
                <p><b class="font-semibold">Publisher(s):</b> Publisher</p>
                <p><b class="font-semibold">Publishing Date:</b> 10/25/2025</p>
              </div>
              <div class="space-y-0.5">
                <p><b class="font-semibold">Original Language:</b> Japanese</p>
                <p>
                  <b class="font-semibold">Available Language(s):</b> English, Japanese
                </p>
              </div>
            </div>
          </div>

          <div class="mb-2">
            <span class="text-lg font-bold mb-2">TAGS</span>
            <div class="flex flex-wrap gap-2">
              <a href="/tag/..." class="text-blue-400 text-sm">
                tag1, tag2, tag3
              </a>
            </div>
          </div>
          <div>
            <span class="text-lg font-bold">LINKS</span>
            <div
              class="bg-card border border-border rounded-md px-4 py-2 text-sm text-muted-foreground"
            >
              Content is hidden from guests, please sign in to access.
            </div>
          </div>
          <button
            id="expand-details-btn"
            class="absolute bottom-0 left-0 right-0 h-4 bg-gradient-to-t from-background to-transparent lg:hidden"
          >
            <Icon name="tabler:chevron-compact-down" class="pt-0.5 w-full" />
          </button>
        </div>
        <div class="w-84 max-[1274px]:hidden"></div>
      </div>

      <aside
        class="flex-1 space-y-6 max-[1274px]:hidden w-84 absolute top-68 right-4 pb-4"
      >
        <div class="bg-card rounded-md px-4 py-2 border border-border">
          <span class="text-lg font-bold mb-2">RATING</span>
          <div class="text-center mb-4">
            <div class="text-3xl font-bold">
              9.2 <Icon
                name="tabler:star-filled"
                class="inline -translate-y-1 text-yellow-500"
              />
            </div>
            <div class="text-sm text-muted-foreground">
              {novel.num_ratings} ratings
            </div>
          </div>
          <div class="space-y-2 flex-1">
            {
              [
                { rating: 10, percentage: 45.2, count: 235 },
                { rating: 9, percentage: 28.7, count: 149 },
                { rating: 8, percentage: 12.4, count: 64 },
                { rating: 7, percentage: 5.3, count: 28 },
                { rating: 6, percentage: 3.1, count: 16 },
                { rating: 5, percentage: 2.2, count: 11 },
                { rating: 4, percentage: 1.5, count: 8 },
                { rating: 3, percentage: 0.8, count: 4 },
                { rating: 2, percentage: 0.5, count: 3 },
                { rating: 1, percentage: 0.3, count: 2 },
              ].map(({ rating, percentage, count }) => (
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium w-6 text-right">
                    {rating}
                  </span>
                  <div class="flex-1 h-2 bg-muted rounded overflow-hidden">
                    <div
                      class="h-full bg-yellow-500"
                      style={`width: ${percentage}%`}
                    />
                  </div>
                  <span class="text-xs w-16 text-right">
                    {percentage}% ({count})
                  </span>
                </div>
              ))
            }
          </div>
        </div>

        <div class="bg-card rounded-md px-4 py-2 border border-border">
          <span class="text-lg font-bold mb-2">RECOMMENDATIONS</span>
          <div class="flex gap-2 mb-4">
            <button
              class="flex-1 px-3 py-2 text-sm rounded-md font-medium bg-foreground/5"
            >
              SYSTEM
            </button>
            <button
              class="flex-1 px-3 py-2 text-sm rounded-md hover:bg-foreground/8"
            >
              USER
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <GridNovelResults
              novels={Array.from({ length: 5 }, () => ({ ...novel }))}
            />
          </div>
        </div>
      </aside>
    </div>

    <div class="flex flex-1 gap-4">
      <div class="flex flex-col flex-1">
        <div class="mb-2">
          <span class="text-lg font-bold mb-2">CHAPTERS</span>
          <div>TODO: collapsible volumes/chapters here</div>
        </div>

        <div class="flex-1 flex-col gap-4 max-[1274px]:flex hidden">
          <div
            id="rating-container"
            class="h-28 lg:h-auto overflow-hidden relative"
          >
            <div class="bg-card rounded-md px-4 py-2 border border-border">
              <span class="text-lg font-bold mb-2">RATING</span>
              <div class="text-center mb-4">
                <div class="text-3xl font-bold">
                  9.2 <Icon
                    name="tabler:star-filled"
                    class="inline -translate-y-1 text-yellow-500"
                  />
                </div>
                <button
                  id="expand-rating-btn"
                  class="absolute bottom-0 left-0 right-0 h-4 bg-gradient-to-t from-background to-transparent lg:hidden"
                >
                  <Icon
                    name="tabler:chevron-compact-down"
                    class="pt-0.5 w-full"
                  />
                </button>
                <div class="text-sm text-muted-foreground">
                  {novel.num_ratings} ratings
                </div>
              </div>
              <div class="space-y-2 flex-1">
                {
                  [
                    { rating: 10, percentage: 45.2, count: 235 },
                    { rating: 9, percentage: 28.7, count: 149 },
                    { rating: 8, percentage: 12.4, count: 64 },
                    { rating: 7, percentage: 5.3, count: 28 },
                    { rating: 6, percentage: 3.1, count: 16 },
                    { rating: 5, percentage: 2.2, count: 11 },
                    { rating: 4, percentage: 1.5, count: 8 },
                    { rating: 3, percentage: 0.8, count: 4 },
                    { rating: 2, percentage: 0.5, count: 3 },
                    { rating: 1, percentage: 0.3, count: 2 },
                  ].map(({ rating, percentage, count }) => (
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium w-6 text-right">
                        {rating}
                      </span>
                      <div class="flex-1 h-2 bg-muted rounded">
                        <div
                          class="h-full bg-yellow-500"
                          style={`width: ${percentage}%`}
                        />
                      </div>
                      <span class="text-xs w-16 text-right">
                        {percentage}% ({count})
                      </span>
                    </div>
                  ))
                }
              </div>
            </div>
          </div>

          <div class="bg-card rounded-md px-4 py-2 border border-border mb-2">
            <span class="text-lg font-bold">RECOMMENDATIONS</span>
            <div class="flex gap-2 mb-4">
              <button
                class="flex-1 px-3 py-2 text-sm rounded-md font-medium bg-foreground/5"
              >
                SYSTEM
              </button>
              <button
                class="flex-1 px-3 py-2 text-sm rounded-md hover:bg-foreground/8"
              >
                USER
              </button>
            </div>
            <div
              class="grid gap-4 [grid-template-columns:repeat(auto-fit,minmax(144px,1fr))]"
            >
              <GridNovelResults
                novels={Array.from({ length: 5 }, () => ({ ...novel }))}
              />
            </div>
          </div>
        </div>
        <div class="mb">
          <span class="text-lg font-bold mb-2">COMMENTS</span>
          <div>TODO: comments here</div>
        </div>
      </div>

      <div class="w-84 max-[1274px]:hidden"></div>
    </div>
  </BaseLayout>

  <script>
    document.addEventListener("astro:page-load", () => {
      const title = document.getElementById("novel-title");
      const ratingContainer = document.getElementById("rating-container");
      const detailsContainer = document.getElementById("details-container");
      const expandRatingBtn = document.getElementById("expand-rating-btn");
      const expandDetailsBtn = document.getElementById("expand-details-btn");

      function fitTitle(element: HTMLElement) {
        let minSize = 20;
        let maxSize = 64;

        while (maxSize - minSize > 1) {
          const midSize = (minSize + maxSize) / 2;
          element.style.fontSize = midSize + "px";

          if (element.scrollHeight > element.clientHeight) {
            maxSize = midSize;
          } else {
            minSize = midSize;
          }
        }
        element.style.fontSize = minSize + "px";
      }

      if (title) {
        const resizeObserver = new ResizeObserver(() => fitTitle(title));
        resizeObserver.observe(title.parentElement);

        document.fonts.ready.then(() => {
          fitTitle(title);
          title.style.visibility = "visible";
        });
      }

       expandRatingBtn.addEventListener("click", (e) => {
        e.preventDefault();
        expandRatingBtn.style.display = "none";
        ratingContainer.style.height = "auto";
      });

      expandDetailsBtn.addEventListener("click", (e) => {
        e.preventDefault();
        expandDetailsBtn.style.display = "none";
        detailsContainer.style.height = "auto";
      });
    });
  </script>
</div>
